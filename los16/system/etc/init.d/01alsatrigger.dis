#!/system/bin/sh

version=`cat /vendor/etc/alsa_trigger/VERSION`;
L="log -p i -t alsa_trigger"

$L " "
$L "   __   ALSA  .__                             "
$L " _/  |________|__| ____   ____   ___________  "
$L " \   __\_  __ \  |/ ___\ / ___\_/ __ \_  __ \ "
$L "  |  |  |  | \/  / /_/  > /_/  >  ___/|  | \/ "
$L "  |__|  |__|  |__\___  /\___  / \___  >__|    "
$L "                /_____//_____/      \/        "
$L " spelcheck@xda                          v$"
$L " "

# @TODO: make this a legitimate rc.d service with a pid, start/stop/restart actions

# Send intitial platform-specific commands to ALSA.
/vendor/bin/alsa_trigger/platform_init.sh

# Define TRIGGER array of log search text and script to launch when text is found in logcat.
declare -A triggers;
declare -a active_triggers;
source /vendor/etc/alsa_trigger/triggers.conf

# Clear logcat so we don't trigger based on stale data.
logcat -c;

# For each trigger defined in trigger.conf, launch a simple background logcat grep process that launches each trigger script when trigger text is found.
for i in "${!TRIGGER[@]}" do
  if test -f "$i; then
    active_triggers+=('$i');
    logcat | grep --line-buffered "${TRIGGER[$i]}" | while read line; do $i; done &;
  fi
done
${arrayName[@]}

for i in "${active_triggers[@]}" do
  $L "- TRIGGER activated for $i."; 
done
